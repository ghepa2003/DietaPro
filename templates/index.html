<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>DietaPro - Web</title>
    <style>
      body{font-family:Arial;max-width:1100px;margin:20px auto}
      label{display:block;margin-top:6px}
      .meal{border:1px solid #ddd;padding:10px;margin:8px 0}
      .suggestions{position:relative}
      .suggestions-list{position:absolute;z-index:9999;background:#fff;border:1px solid #ccc;max-height:200px;overflow:auto;width:100%;box-sizing:border-box}
      .suggestions-list div{padding:6px;cursor:pointer}
      .suggestions-list div:hover{background:#eee}
      input.food-input{width:100%}
      .row{display:flex;gap:10px}
      .col{flex:1}
      #daily_totals_container{margin-top:12px;padding:8px;border:1px dashed #ccc}
      button{cursor:pointer}
    </style>
  </head>
  <body>
    <h1>DietaPro - Pianificazione giornaliera</h1>

    <!-- non mette action: tutto via AJAX -->
    <form id="mainForm" onsubmit="return false;">
      <fieldset style="border:1px solid #ccc; padding:8px; margin-bottom:10px;">
        <legend>Aggiungi alimento</legend>
        <div class="row">
          <div class="col">
            <label>Nome
              <div class="suggestions">
                <input id="new_nome" placeholder="es. quinoa" autocomplete="off">
              </div>
            </label>
          </div>
          <div class="col">
            <label>Categoria
              <select id="new_categoria">
                <option value="carboidrati">carboidrati</option>
                <option value="proteine">proteine</option>
                <option value="grassi">grassi</option>
                <option value="frutta">frutta</option>
                <option value="verdura">verdura</option>
              </select>
            </label>
          </div>
        </div>
        <div class="row">
          <div class="col"><label>Calorie <input id="new_calorie" type="number" step="0.1"></label></div>
          <div class="col"><label>Carboidrati (g/100g) <input id="new_carbo" type="number" step="0.1"></label></div>
          <div class="col"><label>Proteine (g/100g) <input id="new_prot" type="number" step="0.1"></label></div>
          <div class="col"><label>Grassi (g/100g) <input id="new_fat" type="number" step="0.1"></label></div>
        </div>
        <button type="button" id="btn_add_food">Aggiungi/aggiorna alimento</button>
        <span id="add_food_status" style="margin-left:8px;"></span>
      </fieldset>
      <h3>Impostazioni globali</h3>
      <label>Calorie totali giornata
        <input id="calorie_tot" name="calorie_tot" value="{{ defaults.calorie_tot if defaults is defined else 2000 }}">
      </label>

      <div class="row">
        {% for m in MEALS %}
        <div class="col">
          <label>Percentuale kcal {{ m }}
            <input name="perc_pasti_{{m}}" class="perc_pasti" value="{{ (defaults.perc_pasti[m] if defaults is defined else (0.25 if m=='colazione' else (0.4))) }}">
          </label>
        </div>
        {% endfor %}
      </div>

      <h4>Macro giornalieri (percentuali) — solo riferimento</h4>
      <div class="row">
        <div class="col"><label>Carbo <input id="macro_tot_carbo" value="{{ defaults.macro_tot.carbo if defaults is defined else 0.5 }}"></label></div>
        <div class="col"><label>Proteine <input id="macro_tot_prot" value="{{ defaults.macro_tot.prot if defaults is defined else 0.3 }}"></label></div>
        <div class="col"><label>Grassi <input id="macro_tot_fat" value="{{ defaults.macro_tot.fat if defaults is defined else 0.2 }}"></label></div>
      </div>

      <h3>Macro e scelte per pasto</h3>
      {% for m in MEALS %}
      <div class="meal" id="meal_{{m}}">
        <h4>{{ m|capitalize }}</h4>

        <div class="row">
          <div class="col"><label>Carbo <input name="macro_{{m}}_carbo" value="{{ defaults.macro_pasti[m].carbo if defaults is defined else 0.5 }}"></label></div>
          <div class="col"><label>Prot <input name="macro_{{m}}_prot" value="{{ defaults.macro_pasti[m].prot if defaults is defined else 0.3 }}"></label></div>
          <div class="col"><label>Fat <input name="macro_{{m}}_fat" value="{{ defaults.macro_pasti[m].fat if defaults is defined else 0.2 }}"></label></div>
        </div>

        <div class="row">
          <div class="col"><label>Fruit ratio <input name="{{m}}_fruit_ratio" value="0.05"></label></div>
          <div class="col"><label>Veg ratio <input name="{{m}}_veg_ratio" value="0.0"></label></div>
        </div>

        <h5>Scelte alimenti (separare con virgola) — solo categoria corretta</h5>
        {% for cat in ['carboidrati','proteine','grassi','frutta','verdura'] %}
          <label>{{ cat }}:
            <div class="suggestions">
              <input class="food-input" data-cat="{{cat}}" id="{{m}}_{{cat}}"  {% if cat =='carboidrati' %} placeholder="es. riso, pasta"  {% elif cat == 'proteine' %} placeholder="es. pollo, tonno" {% elif cat == 'frutta' %} placeholder="es. mela, banana" {% elif cat == 'verdura' %} placeholder="es. insalata, broccoli" {% elif cat == 'grassi' %} placeholder="es. olio, burro" {% endif %} autocomplete="off"
                value="{{ (','.join(meal_choices[m][cat]) if meal_choices is defined and m in meal_choices else '') }}">
            </div>
          </label>
        {% endfor %}

        <label>Split per questo pasto (una per riga, es. "riso,pane=50" o "uova,noci=70,30" — non includere frutta/verdura)</label>
        <textarea id="splits_{{m}}" rows="2" cols="60">{{ splits_per_meal[m]|join('\n') if splits_per_meal is defined and m in splits_per_meal else '' }}</textarea>

        <div style="margin-top:8px">
          <button type="button" onclick="calcSingle('{{m}}')">Calcola solo questo pasto </button>
          <button type="button" onclick="calcDay()">Calcola giornata </button>
          <span style="margin-left:12px;">
            <span id="totals_{{m}}"></span>
          </span>
        </div>

        <div id="perfood_{{m}}" style="margin-top:8px"></div>
      </div>
      {% endfor %}

      <p style="margin-top:10px;">
        <button type="button" onclick="calcDay()">Calcola giornata </button>
      </p>
    </form>

    <div id="daily_totals_container"></div>

    <script>
      (function(){
        const foodsByCat = JSON.parse('{{ foods_by_cat|tojson | safe if foods_by_cat is defined else "{}" }}');
        const computeMealUrl = "{{ url_for('compute_meal') }}";
        const computeDayUrl  = "{{ url_for('compute_day') }}";
        const addFoodUrl     = "{{ url_for('add_food') }}";
        const getFoodUrl     = "{{ url_for('get_food') }}";
        window.MEALS = JSON.parse('{{ MEALS|tojson | safe }}');

        // autocomplete helpers
        function currentToken(val){
          const i = val.lastIndexOf(',');
          if(i === -1) return {prefix:'', token: val};
          return {prefix: val.slice(0, i+1), token: val.slice(i+1)};
        }

        function attachAutocomplete(input){
          const container = input.parentElement;
          let listDiv = container.querySelector('.suggestions-list');
          if(!listDiv){
            listDiv = document.createElement('div');
            listDiv.className = 'suggestions-list';
            container.appendChild(listDiv);
            listDiv.style.display = 'none';
          }
          input.addEventListener('input', ()=>{
            const cat = input.dataset.cat || 'carboidrati'; // read dynamically
            const raw = input.value;
            const {prefix, token} = currentToken(raw);
            const q = token.trim().toLowerCase();
            if(q.length === 0){ listDiv.style.display = 'none'; return; }
            const pool = foodsByCat[cat] || [];
            const matches = pool.filter(f => f.toLowerCase().includes(q)).slice(0,200);
            if(matches.length === 0){ listDiv.style.display = 'none'; return; }
            listDiv.innerHTML = '';
            matches.forEach(m => {
              const d = document.createElement('div'); d.textContent = m;
              d.addEventListener('mousedown', ()=>{
                input.value = (prefix + ' ' + m).replace(/^\s+/, '') + ', ';
                input.focus();
                setTimeout(()=>listDiv.style.display='none', 0);
              });
              listDiv.appendChild(d);
            });
            listDiv.style.display = 'block';
          });
          input.addEventListener('blur', ()=>{ setTimeout(()=>{ listDiv.style.display='none'; }, 150); });
        }

        // autocomplete for "Aggiungi alimento" (single token, filtered by selected category)
        function attachAddFoodAutocomplete(){
          const input = document.getElementById('new_nome');
          const selectCat = document.getElementById('new_categoria');
          const container = input.parentElement;
          let listDiv = container.querySelector('.suggestions-list');
          if(!listDiv){
            listDiv = document.createElement('div');
            listDiv.className = 'suggestions-list';
            container.appendChild(listDiv);
            listDiv.style.display = 'none';
          }
          async function fillFieldsFromServer(nome, categoria){
            try{
              const url = `${getFoodUrl}?categoria=${encodeURIComponent(categoria)}&nome=${encodeURIComponent(nome)}`;
              const r = await fetch(url);
              const data = await r.json();
              if(!r.ok || data.error) return;
              document.getElementById('new_calorie').value = data.calorie;
              document.getElementById('new_carbo').value   = data.carboidrati;
              document.getElementById('new_prot').value    = data.proteine;
              document.getElementById('new_fat').value     = data.grassi;
            }catch(e){ /* silent */ }
          }
          input.addEventListener('input', ()=>{
            const q = (input.value || '').trim().toLowerCase();
            if(q.length === 0){ listDiv.style.display = 'none'; return; }
            const cat = selectCat.value;
            const pool = foodsByCat[cat] || [];
            const matches = pool.filter(f => f.toLowerCase().includes(q)).slice(0,200);
            if(matches.length === 0){ listDiv.style.display = 'none'; return; }
            listDiv.innerHTML = '';
            matches.forEach(m => {
              const d = document.createElement('div'); d.textContent = m;
              d.addEventListener('mousedown', async ()=>{
                input.value = m;
                setTimeout(()=>listDiv.style.display='none', 0);
                await fillFieldsFromServer(m, cat);
              });
              listDiv.appendChild(d);
            });
            listDiv.style.display = 'block';
          });
          input.addEventListener('blur', ()=>{ setTimeout(()=>{ listDiv.style.display='none'; }, 150); });
          // when category changes, hide list and clear fields optionally
          selectCat.addEventListener('change', ()=>{
            listDiv.style.display = 'none';
          });
        }

        document.querySelectorAll('input.food-input').forEach(attachAutocomplete);
        attachAddFoodAutocomplete();

        // add-food handler
        document.getElementById('btn_add_food').addEventListener('click', async ()=>{
          const status = document.getElementById('add_food_status');
          status.textContent = '';
          const payload = {
            nome: (document.getElementById('new_nome').value||'').trim(),
            categoria: document.getElementById('new_categoria').value,
            calorie: parseFloat(document.getElementById('new_calorie').value||'0'),
            carboidrati: parseFloat(document.getElementById('new_carbo').value||'0'),
            proteine: parseFloat(document.getElementById('new_prot').value||'0'),
            grassi: parseFloat(document.getElementById('new_fat').value||'0')
          };
          try{
            const r = await fetch(addFoodUrl, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
            const data = await r.json();
            if(!r.ok || data.error){ throw new Error(data.error||'Errore'); }
            // aggiorna le liste locali per l'autocomplete
            const cat = data.item.categoria;
            const nome = data.item.nome;
            foodsByCat[cat] = foodsByCat[cat] || [];
            if(!foodsByCat[cat].includes(nome)) foodsByCat[cat].push(nome);
            foodsByCat[cat].sort((a,b)=>a.localeCompare(b));
            status.textContent = 'Salvato';
            status.style.color = 'green';
          }catch(e){
            console.error(e);
            status.textContent = 'Errore salvataggio';
            status.style.color = 'red';
          }
        });

        function readPercPasti(){
          const out = {};
          document.querySelectorAll('input[name^="perc_pasti_"]').forEach(i=>{
            const name = i.name.replace('perc_pasti_','');
            out[name] = parseFloat(i.value) || 0;
          });
          return out;
        }
        function readMacroPasti(){
          const out = {};
          (window.MEALS || []).forEach(function(m){
            out[m] = {
              carbo: parseFloat(document.querySelector('input[name="macro_' + m + '_carbo"]').value) || 0.5,
              prot:  parseFloat(document.querySelector('input[name="macro_' + m + '_prot"]').value) || 0.3,
              fat:   parseFloat(document.querySelector('input[name="macro_' + m + '_fat"]').value) || 0.2
            };
          });
          return out;
        }

        function readChoicesFor(meal){
          const out = {};
          ['carboidrati','proteine','grassi','frutta','verdura'].forEach(cat=>{
            const val = (document.getElementById(`${meal}_${cat}`).value || '');
            out[cat] = val.split(',').map(s=>s.trim()).filter(Boolean);
          });
          return out;
        }

        function readAllChoices(){
          const out = {};
          (window.MEALS || []).forEach(function(m){
            out[m] = readChoicesFor(m);
          });
          return out;
        }

        function readSplitsPerMeal(){
          const out = {};
          (window.MEALS || []).forEach(function(m){
            out[m] = document.getElementById('splits_' + m).value || "";
          });
          return out;
        }

        function updateDailyTotalsFromDOM(){
          let kcal=0, carbo=0, prot=0, fat=0;
          document.querySelectorAll('[id^="totals_"]').forEach(span=>{
            const k = parseFloat(span.querySelector('.kcal')?.textContent) || 0;
            const c = parseFloat(span.querySelector('.carbo')?.textContent) || 0;
            const p = parseFloat(span.querySelector('.prot')?.textContent) || 0;
            const f = parseFloat(span.querySelector('.fat')?.textContent) || 0;
            kcal += k; carbo += c; prot += p; fat += f;
          });
          const el = document.getElementById('daily_totals_container');
          el.innerHTML = `<h3>Totali giorno (visivi)</h3>
                          <p>${kcal.toFixed(1)} kcal — C: ${carbo.toFixed(1)} g P: ${prot.toFixed(1)} g F: ${fat.toFixed(1)} g</p>`;
        }

        function normalizeName(s){
          return (s || '').trim().toLowerCase().replace(/\s+/g,' ');
        }
        function sanitizeSplitsText(text, fruitList, vegList){
          const fruitSet = new Set((fruitList||[]).map(normalizeName));
          const vegSet   = new Set((vegList||[]).map(normalizeName));
          const lines = (text || '').split(/\r?\n/);
          const kept = [];
          let removed = 0;
          for(const line of lines){
            const raw = line.trim();
            if(!raw) { kept.push(line); continue; }
            const left = raw.split('=')[0] || '';
            const parts = left.split(',').map(s=>normalizeName(s)).filter(Boolean);
            if(parts.length >= 2){
              const a = parts[0], b = parts[1];
              const hit = fruitSet.has(a) || fruitSet.has(b) || vegSet.has(a) || vegSet.has(b);
              if(hit){ removed++; continue; }
            }
            kept.push(line);
          }
          return { text: kept.join('\n'), removed };
        }

        window.calcSingle = function(meal){
          const choices = readChoicesFor(meal);
          const rawSplits = document.getElementById(`splits_${meal}`).value || "";
          const sanitized = sanitizeSplitsText(rawSplits, choices.frutta, choices.verdura);

          const payload = {
            meal: meal,
            calorie_tot: parseFloat(document.getElementById('calorie_tot').value) || 2000,
            perc_pasti: readPercPasti(),
            macro_pasti: readMacroPasti(),
            choices: choices,
            fruit_ratio: parseFloat(document.querySelector(`input[name="${meal}_fruit_ratio"]`).value) || 0,
            veg_ratio: parseFloat(document.querySelector(`input[name="${meal}_veg_ratio"]`).value) || 0,
            splits_text: sanitized.text
          };

          fetch(computeMealUrl, {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify(payload)
          })
          .then(async r=>{
            const text = await r.text();
            let data = null;
            try{ data = text ? JSON.parse(text) : null; }catch(e){ /* not JSON */ }
            if(!r.ok){
              const msg = (data && (data.error || data.message)) || text || (`HTTP ${r.status}`);
              throw new Error(msg);
            }
            if(data && data.error){
              throw new Error(data.error);
            }
            return data;
          })
          .then(data=>{
            const t = data.totals;
            const totalsSpan = document.getElementById(`totals_${meal}`);
            totalsSpan.innerHTML = `Totali pasto: <span class="kcal">${t.kcal.toFixed(1)}</span> kcal — C: <span class="carbo">${t.carbo.toFixed(1)}</span> g P: <span class="prot">${t.proteine.toFixed(1)}</span> g F: <span class="fat">${t.grassi.toFixed(1)}</span> g`;
            const pfDiv = document.getElementById(`perfood_${meal}`);
            let html = "<ul>";
            data.per_food.forEach(p => {
              html += `<li>${p.nome}: ${p.grammi.toFixed(1)} g — ${p.kcal.toFixed(1)} kcal (C:${p.carbo.toFixed(1)} P:${p.proteine.toFixed(1)} F:${p.grassi.toFixed(1)})</li>`;
            });
            html += "</ul>";
            pfDiv.innerHTML = html;
            updateDailyTotalsFromDOM();
          })
          .catch(err=>{
            console.error(err);
            alert('Errore calcolo pasto: ' + (err && err.message ? err.message : ''));
          });
        };

        window.calcDay = function(){
          const allChoices = readAllChoices();
          const raw = readSplitsPerMeal();
          const sanitizedPerMeal = {};
          (window.MEALS || []).forEach(function(m){
            const s = sanitizeSplitsText(raw[m] || "", allChoices[m]?.frutta || [], allChoices[m]?.verdura || []);
            sanitizedPerMeal[m] = s.text;
          });

          const payload = {
            calorie_tot: parseFloat(document.getElementById('calorie_tot').value) || 2000,
            perc_pasti: readPercPasti(),
            macro_pasti: readMacroPasti(),
            choices: allChoices,
            fruit_ratios: (function(){ const o={}; (window.MEALS || []).forEach(function(m){ o[m] = parseFloat(document.querySelector('input[name="'+m+'_fruit_ratio"]').value) || 0; }); return o; })(),
            veg_ratios:   (function(){ const o={}; (window.MEALS || []).forEach(function(m){ o[m] = parseFloat(document.querySelector('input[name="'+m+'_veg_ratio"]').value) || 0; }); return o; })(),
            splits_per_meal: sanitizedPerMeal
          };

          fetch(computeDayUrl, {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify(payload)
          })
          .then(async r=>{
            const text = await r.text();
            let data = null;
            try{ data = text ? JSON.parse(text) : null; }catch(e){ /* not JSON */ }
            if(!r.ok){
              const msg = (data && (data.error || data.message)) || text || (`HTTP ${r.status}`);
              throw new Error(msg);
            }
            if(data && data.error){
              throw new Error(data.error);
            }
            return data;
          })
          .then(data=>{
            const res = data.results || {};
            for(const meal in res){
              const t = res[meal].totals || {};
              const totalsSpan = document.getElementById(`totals_${meal}`);
              totalsSpan.innerHTML = `Totali pasto: <span class="kcal">${(t.kcal||0).toFixed(1)}</span> kcal — C: <span class="carbo">${(t.carbo||0).toFixed(1)}</span> g P: <span class="prot">${(t.proteine||0).toFixed(1)}</span> g F: <span class="fat">${(t.grassi||0).toFixed(1)}</span> g`;
              const qf = res[meal].quant_frutta;
              const qv = res[meal].quant_verdura;
              if(qf !== null && qf !== undefined){ totalsSpan.innerHTML += ` <br><small>Frutta: ${qf.toFixed(1)} g</small>`; }
              if(qv !== null && qv !== undefined){ totalsSpan.innerHTML += ` <br><small>Verdura: ${qv.toFixed(1)} g</small>`; }
              const pfDiv = document.getElementById(`perfood_${meal}`);
              let html = "<ul>";
              (res[meal].per_food||[]).forEach(p => {
                html += `<li>${p.nome}: ${p.grammi.toFixed(1)} g — ${p.kcal.toFixed(1)} kcal (C:${p.carbo.toFixed(1)} P:${p.proteine.toFixed(1)} F:${p.grassi.toFixed(1)})</li>`;
              });
              html += "</ul>";
              pfDiv.innerHTML = html;
            }
            const td = data.total_day || {};
            const el = document.getElementById('daily_totals_container');
            el.innerHTML = `<h3>Totali giorno (calcolo)</h3>
                            <p>${(td.kcal||0).toFixed(1)} kcal — C: ${(td.carbo||0).toFixed(1)} g P: ${(td.proteine||0).toFixed(1)} g F: ${(td.grassi||0).toFixed(1)} g</p>`;
          })
          .catch(err=>{
            console.error(err);
            alert('Errore calcolo giornata: ' + (err && err.message ? err.message : ''));
          });
        };

        // === Persistenza locale dei dati iniziali (localStorage) ===
        function persistKeyFor(el){
          if(el.name && el.name.trim()) return 'persist:name:' + el.name.trim();
          if(el.id && el.id.trim())     return 'persist:id:' + el.id.trim();
          return null;
        }
        function restorePersisted(){
          const fields = document.querySelectorAll('input, textarea, select');
          fields.forEach(el=>{
            const key = persistKeyFor(el);
            if(!key) return;
            const saved = localStorage.getItem(key);
            if(saved !== null){
              // handle numeric inputs gracefully
              if(el.type === 'number'){
                el.value = saved;
              }else{
                el.value = saved;
              }
            }
          });
        }
        function attachPersistHandlers(){
          const save = (el)=>{
            const key = persistKeyFor(el);
            if(!key) return;
            localStorage.setItem(key, el.value ?? '');
          };
          const fields = document.querySelectorAll('input, textarea, select');
          fields.forEach(el=>{
            el.addEventListener('input', ()=>save(el));
            el.addEventListener('change', ()=>save(el));
          });
        }

        // Ripristina subito i valori salvati e attiva il salvataggio automatico
        restorePersisted();
        attachPersistHandlers();

        // inizializza visuale
        updateDailyTotalsFromDOM();
        // assicurati che non ci sia testo residuo nei totali o nelle liste per pasto
        document.querySelectorAll('[id^="totals_"]').forEach(el => { el.innerHTML = ''; });
        document.querySelectorAll('[id^="perfood_"]').forEach(el => { el.innerHTML = ''; });
      })();
    </script>
  </body>
</html>
